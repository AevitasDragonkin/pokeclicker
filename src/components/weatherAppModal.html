<div class="modal fade" id="weatherAppModal" tabindex="-1" role="dialog" aria-labelledby="weatherAppModal">
    <div class="modal-dialog modal-dialog-scrollable modal-lg h-100" role="document">
        <div class="modal-content">
            <div class="modal-header p-0">
                <ul class="nav nav-tabs nav-fill w-100">
                    <li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#castform-app">Castform App</a></li>
                    <li class="nav-item"><a data-toggle="tab" class="nav-link" href="#weather-override">Weather Override</a></li>
                    <li class="d-block"><button type="button" class="btn btn-danger" data-dismiss="modal" style="font-size: 18px; font-weight: 700;">×</button></li>
                </ul>
            </div>

            <div class="modal-body tab-content">
                <div id="castform-app" class="tab-pane fade in active show">
                    <div class="container">
                        <div class="row mb-2">
                            <!-- ko using: GameHelper.enumNumbers(GameConstants.Region).filter((r) => r >= 0 && r <= player.highestRegion()), as: 'regions' -->
                            <select class="custom-select" onchange="WeatherApp.selectedRegion(+this.value);">
                                <!-- ko foreach: regions -->
                                <option data-bind="attr: { value: $data, selected: WeatherApp.selectedRegion() === $data }, text: GameConstants.camelCaseToString(GameConstants.Region[$data])"></option>
                                <!-- /ko -->
                            </select>
                            <!-- /ko -->
                        </div>
                        <div class="row m-0 w-100 h-100">
                            <div class="col-2 w-100 px-0" id="timeTable">
                                <table class="w-100 h-100" border="1">
                                    <thead>
                                    <tr>
                                        <th style="height: 26px;">Time</th>
                                    </tr>
                                    </thead>
                                    <tbody data-bind="foreach: WeatherApp.generateHourList()">
                                    <tr>
                                        <td style="height: 60px;" data-bind="text: `${GameHelper.twoDigitNumber(+$data)}:00 - ${GameHelper.twoDigitNumber(+$data + (Weather.period - 1))}:59`"></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-10 w-100 px-0 overflow-auto" id="forecastTable">
                                <table class="w-100 h-100" border="1">
                                    <thead>
                                    <tr>
                                        <!-- ko foreach: WeatherApp.dateList() -->
                                        <th style="height: 26px;" data-bind="text: GameConstants.DayOfWeek[$data.getDay()].slice(0, 3),
                                        tooltip: {
                                            title: $data.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
                                            placement: 'bottom',
                                            trigger: 'hover',
                                            boundary: 'window',
                                        }">
                                        </th>
                                        <!-- /ko -->
                                    </tr>
                                    </thead>
                                    <tbody data-bind="foreach: { data: WeatherApp.fullForecast().find((rf) => rf.region == WeatherApp.selectedRegion()).weatherForecastList(), as: 'hourForecast' }">
                                    <tr class="py-2" data-bind="template: { name: 'weatherAppTemplate', data: {'hourForecast': hourForecast, 'region': WeatherApp.selectedRegion()} }"></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ko let: { overrideRegion: ko.observable(GameConstants.Region.kanto), cycles: ko.observable(1) } -->
                <div id="weather-override" class="tab-pane fade">
                    <div class="d-flex flex-wrap justify-content-center" style="gap: 1rem;">
                        <!-- ko foreach: [...new Set(Object.values(WeatherOverride.weatherCost).flatMap(value => value).map(value => value.item.name))] -->
                        <div class="d-flex flex-column align-items-center">
                            <img class="pixelated" src="" alt="" style="height: 26px;" data-bind="attr: { src: ItemList[$data].image }">
                            <div class="small" data-bind="text: `${ItemList[$data].displayName}`"></div>
                            <div class="small" data-bind="text: `[${player.itemList[$data]().toLocaleString('en-US')}]`"></div>
                        </div>
                        <!-- /ko -->
                    </div>

                    <hr>

                    <div class="mb-2">
                        <!-- ko using: GameHelper.enumNumbers(GameConstants.Region).filter((r) => r >= 0 && r <= player.highestRegion()), as: 'regions' -->
                        <label for="weather-override-region-select">Select region</label>
                        <select id="weather-override-region-select" autocomplete="off" class="custom-select" data-bind="
                            options: regions.map(region => ({ value: region, text: GameConstants.camelCaseToString(GameConstants.Region[region]) })),
                            optionsValue: 'value',
                            optionsText: 'text',
                            value: overrideRegion">
                        </select>
                        <!-- /ko -->
                    </div>

                    <div>Select cycles</div>

                    <div class="input-group">
                        <button class="btn btn-warning btn-outline-dark smallButton smallFont" data-bind="click: () => cycles(1)">Reset</button>
                        <input type="number" min="1" class="outline-dark form-control form-control-number" oninput="this.value = Math.max(this.value, 1)" data-bind="textInput: cycles">
                        <div>
                            <code data-bind="text: GameConstants.formatTime(WeatherOverride.CYLCE_TIME * cycles())"></code>
                        </div>
                    </div>

                    <table class="table table-striped table-hover table-bordered table-sm m-0">
                        <tbody>
                        <!-- ko foreach: { data: App.game.weatherOverride.getAllowedWeather(overrideRegion()), as: 'weatherType' } -->
                        <tr data-bind="
                            css: {
                                'active-weather-highlight': weatherType === Weather.getRegionalWeather(overrideRegion()),
                                'original-weather-highlight': weatherType === Weather._regionalWeather[overrideRegion()]()
                            }
                        ">
                            <td class="vertical-middle" data-bind="style: { background: Weather.weatherConditions[weatherType].color }">
                                <img width=30px src="" data-bind="attr: { src: `assets/images/weather/${WeatherType[weatherType]}.png` }"/>
                            </td>
                            <td class="vertical-middle text-left" data-bind="text: GameConstants.humanifyString(WeatherType[weatherType])"></td>
                            <td class="vertical-middle text-left" data-bind="html: Weather.weatherConditions[weatherType].tooltip"></td>
                            <td class="vertical-middle">
                                <!-- ko foreach: WeatherOverride.weatherCost[weatherType] -->
                                <div class="d-flex" style="gap: 1rem;">
                                    <div><img data-bind="attr: { src: $data.item.image }" height="24px"></div>
                                    <div class="text-left" data-bind="text: `${Math.floor($data.amount * App.game.weatherOverride.calculateCostMultiplier(overrideRegion(), cycles())).toLocaleString('en-US')} × ${$data.item.displayName}`"></div>
                                </div>
                                <!-- /ko -->
                            </td>
                            <td class="vertical-middle">
                                <button class="btn btn-secondary" data-bind="
                                    click: () => { App.game.weatherOverride.purchaseWeatherOverride(overrideRegion(), weatherType, cycles()) },
                                    enabled: App.game.weatherOverride.canAffordWeather(weatherType, App.game.weatherOverride.calculateCostMultiplier(overrideRegion(), cycles()))
                                ">
                                    Activate
                                </button>
                            </td>
                        </tr>
                        <!-- /ko -->
                        </tbody>
                    </table>
                </div>
                <!-- /ko -->
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="weatherAppTemplate">
    <!-- ko foreach: { data: $data.hourForecast, as: 'weatherForecast' } -->
    <td class="px-3 clickable" style="height: 60px; position: relative;"
        data-bind="css: { 'weatherForecastPassed': weatherForecast.status() === WeatherForecastStatus.hasPassed }">
        <button class='btn btn-sm' style="right: 0px; top: 0px; width: auto; height: 41px;"
        data-bind='style: { background: Weather.weatherConditions[weatherForecast.weatherType].color },
            tooltip: {
                title: GameConstants.humanifyString(WeatherType[weatherForecast.weatherType]),
                placement: "bottom",
                trigger: "hover",
                boundary: "window",
            }'>
            <img width=30px src="" data-bind="attr: { src: `assets/images/weather/${WeatherType[weatherForecast.weatherType]}.png` }"/>
        </button>
    </td>
    <!-- /ko -->
</script>
