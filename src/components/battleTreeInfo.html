<!-- ko if: App.game.gameState === GameConstants.GameState.battleTree -->
<div id="battleTreeInformation" class="card sortable-disabled border-secondary mb-3 battle-frontier no-select">
    <div class="card-header p-0">
        <span>Battle Tree</span>
    </div>

    <div class="card-body d-flex flex-column p-2" style="gap: 0.5rem;">
        <!-- Team Selection -->
        <!-- ko if: App.game.battleTree.currentRun && [BattleTreeRunState.TEAM_SELECTION].includes(App.game.battleTree.currentRun.state) -->
        <div class="card">
            <div class="card-body p-2">
                <div class="d-flex justify-content-center mb-2" style="gap: 1rem;">
                    <!-- ko foreach: App.game.battleTree.currentRun.teamA -->
                    <div class="card clickable" style="width: 75px; height: 75px;" data-bind="click: () => App.game.battleTree.currentRun.removePokemonFromPlayerATeam($data.name)">
                        <div class="card-body p-0 d-flex justify-content-center align-items-center">
                            <img class="w-100 h-100" src="" alt="" data-bind="attr: { src: PokemonHelper.getImage(PokemonHelper.getPokemonByName($data.name).id) }">
                        </div>
                    </div>
                    <!-- /ko -->

                    <!-- ko foreach: new Array(3 - App.game.battleTree.currentRun.teamA.length).fill(0) -->
                    <div class="card" style="width: 75px; height: 75px;">
                        <a class="card-body p-0 d-flex justify-content-center align-items-center" href="#battleTreeTeamSelectionModal" data-toggle="modal">
                            <code>Empty</code>
                        </a>
                    </div>
                    <!-- /ko -->
                </div>

                <p class="text-center" style="font-size: 0.6rem; line-height: 1em;">Click on the Empty boxes to select a pokemon</p>

                <div class="d-flex justify-content-center" style="gap: 1rem;">
                    <button class="btn btn-info" data-bind="
                        click: () => App.game.battleTree.currentRun.fillPlayerATeamRandomly(),,
                        tooltip: {
                            trigger: 'hover',
                            title: 'Load random team',
                            placement: 'bottom',
                        }
                    ">
                        ↻
                    </button>

                    <button class="btn btn-success" style="width: 150px;" data-bind="
                        click: () => App.game.battleTree.currentRun.startRun(),
                        enable: App.game.battleTree.currentRun.teamA.length > 0,
                        tooltip: {
                            trigger: 'hover',
                            title: App.game.battleTree.currentRun.teamA.length < 1 ? 'Select at least 1 pokemon for your team' : '',
                            placement: 'bottom',
                        }
                    ">
                        Start
                    </button>

                    <button class="btn btn-info" data-bind="
                        click: () => App.game.battleTree.loadPreviousTeam(),
                        enable: App.game.battleTree.previousTeam.length > 0,
                        tooltip: {
                            trigger: 'hover',
                            title: 'Load previous team',
                            placement: 'bottom',
                        }
                    ">
                        ⏎
                    </button>
                </div>
            </div>
        </div>
        <!-- /ko -->

        <!-- Team Management -->
        <!-- ko if: App.game.battleTree.currentRun && [BattleTreeRunState.BATTLE, BattleTreeRunState.MODIFIER, BattleTreeRunState.REWARD].includes(App.game.battleTree.currentRun.state) -->
        <div class="d-flex flex-wrap justify-content-center" style="gap: 0.5rem">
            <!-- Your Team -->
            <div class="card" style="flex: 1 1 0;">
                <div class="card-header p-1">Your Team</div>
                <div class="card-body p-2">
                    <!-- ko foreach: App.game.battleTree.currentRun.teamA -->
                    <div>
                        <div class="d-flex mb-1" style="gap: 0.5rem">
                            <div>
                                <img width="40" height="40" src="" alt="" data-bind="
                                    css: { 'battle-tree-pokemon-fainted': $data.HP === 0 },
                                    attr: { src: PokemonHelper.getImage(PokemonHelper.getPokemonByName($data.name).id) }
                                ">
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex flex-wrap justify-content-between align-items-center">
                                    <div data-bind="text: $data.name"></div>
                                    <div style="font-size: 0.6rem; line-height: 1em;">Level <knockout data-bind="text: $data.level"></knockout></div>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-danger" role="progressbar" aria-valuemin="0" aria-valuemax="100" data-bind="
                                            css: {
                                                'bg-success': $data.HP / $data.maxHP >= 0.5,
                                                'bg-warning': $data.HP / $data.maxHP >= 0.2 && $data.HP / $data.maxHP < 0.5,
                                                'bg-danger': $data.HP / $data.maxHP < 0.2
                                            },
                                            style: { width: ($data.HP / $data.maxHP).toLocaleString('en-US', { style: 'percent' }) }
                                        ">
                                        <!-- ko if: $data.HP > 0 -->
                                        <span><knockout data-bind="text: $data.HP.toLocaleString('en-US')"></knockout> / <knockout data-bind="text: $data.maxHP.toLocaleString('en-US')"></knockout></span>
                                        <!-- /ko -->
                                        <!-- ko ifnot: $data.HP > 0 -->
                                        <span class="font-italic">Fainted</span>
                                        <!-- /ko -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <table class="table table-bordered table-hover table-sm">
                            <tbody>
                            <tr>
                                <td class="p-0">Attack</td>
                                <td class="p-0"><code data-bind="text: $data.attack"></code></td>
                                <td class="p-0">Defense</td>
                                <td class="p-0"><code data-bind="text: $data.defense"></code></td>
                            </tr>
                            <tr>
                                <td class="p-0">Speed</td>
                                <td class="p-0"><code data-bind="text: $data.speed"></code></td>
                                <td class="p-0">APS</td>
                                <td class="p-0"><code data-bind="text: $data.attacksPerSecond.toFixed(2)"></code></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- /ko -->
                </div>
            </div>

            <!-- Opponent -->
            <div class="card" style="flex: 1 1 0;">
                <div class="card-header p-1">Opponent</div>
                <div class="card-body p-2">
                    <!-- ko foreach: App.game.battleTree.currentRun.teamB -->
                    <div>
                        <div class="d-flex mb-1" style="gap: 0.5rem">
                            <div>
                                <img width="40" height="40" src="" alt="" data-bind="
                                    css: { 'battle-tree-pokemon-fainted': $data.HP === 0 },
                                    attr: { src: PokemonHelper.getImage(PokemonHelper.getPokemonByName($data.name).id, $data.shiny, $data.gender, false) }
                                ">
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex flex-wrap justify-content-between align-items-center">
                                    <div data-bind="text: $data.name"></div>
                                    <div style="font-size: 0.6rem; line-height: 1em;">Level <knockout data-bind="text: $data.level"></knockout></div>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-danger" role="progressbar" aria-valuemin="0" aria-valuemax="100" data-bind="
                                            css: {
                                                'bg-success': $data.HP / $data.maxHP >= 0.5,
                                                'bg-warning': $data.HP / $data.maxHP >= 0.2 && $data.HP / $data.maxHP < 0.5,
                                                'bg-danger': $data.HP / $data.maxHP < 0.2
                                            },
                                            style: { width: ($data.HP / $data.maxHP).toLocaleString('en-US', { style: 'percent' }) }
                                        ">
                                        <!-- ko if: $data.HP > 0 -->
                                        <span><knockout data-bind="text: $data.HP.toLocaleString('en-US')"></knockout> / <knockout data-bind="text: $data.maxHP.toLocaleString('en-US')"></knockout></span>
                                        <!-- /ko -->
                                        <!-- ko ifnot: $data.HP > 0 -->
                                        <span class="font-italic">Fainted</span>
                                        <!-- /ko -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <table class="table table-bordered table-hover table-sm">
                            <tbody>
                            <tr>
                                <td class="p-0">Attack</td>
                                <td class="p-0"><code data-bind="text: $data.attack"></code></td>
                                <td class="p-0">Defense</td>
                                <td class="p-0"><code data-bind="text: $data.defense"></code></td>
                            </tr>
                            <tr>
                                <td class="p-0">Speed</td>
                                <td class="p-0"><code data-bind="text: $data.speed"></code></td>
                                <td class="p-0">APS</td>
                                <td class="p-0"><code data-bind="text: $data.attacksPerSecond.toFixed(2)"></code></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- /ko -->
                </div>
            </div>
        </div>
        <!-- /ko -->

        <!-- ko if: App.game.battleTree.currentRun?.state === BattleTreeRunState.FINISHED -->
        <div>
            <h4>Stage: <knockout data-bind="text: App.game.battleTree.currentRun.stage"></knockout></h4>

            <div class="d-flex justify-content-center mb-2" style="gap: 1rem;">
                <!-- ko foreach: App.game.battleTree.currentRun.teamA -->
                <div class="card" style="width: 75px; height: 75px;">
                    <div class="card-body p-0 d-flex justify-content-center align-items-center">
                        <img class="w-100 h-100" src="" alt="" data-bind="attr: { src: PokemonHelper.getImage(PokemonHelper.getPokemonByName($data.name).id) }">
                    </div>
                </div>
                <!-- /ko -->
            </div>
        </div>
        <!-- /ko -->

        <!-- Modifiers -->
        <!-- ko if: App.game.battleTree.currentRun && [BattleTreeRunState.BATTLE, BattleTreeRunState.MODIFIER, BattleTreeRunState.REWARD, BattleTreeRunState.FINISHED].includes(App.game.battleTree.currentRun.state) -->
        <div class="d-flex flex-wrap justify-content-center" style="gap: 0.25rem">
            <!-- ko foreach: App.game.battleTree.currentRun.modifiers -->
            <div class="p-2 border" data-bind="
                css: {
                    'border-success': $data.impact === BattleTreeModifierImpact.Positive,
                    'border-warning': $data.impact === BattleTreeModifierImpact.Neutral,
                    'border-danger': $data.impact === BattleTreeModifierImpact.Negative,
                },
                tooltip: {
                    trigger: 'hover',
                    title: $data.description,
                    html: true,
                    placement: 'bottom'
                }
            ">
                <knockout data-bind="text: $data.id.toLocaleString('en-US', { useGrouping: false, minimumIntegerDigits: 3 })"></knockout>
            </div>
            <!-- /ko -->
        </div>
        <!-- /ko -->

        <!-- Statistics -->
        <!-- ko if: App.game.battleTree.currentRun && [BattleTreeRunState.FINISHED].includes(App.game.battleTree.currentRun.state) -->
        <table class="table table-striped table-hover table-bordered table-sm m-0">
            <tbody>
            <tr>
                <td class="text-left">Runtime</td>
                <td class="text-left tight"><code data-bind="text: GameConstants.formatTime(App.game.battleTree.currentRun.runTime)"></code></td>
            </tr>
            <tr>
                <td class="text-left">Combat time</td>
                <td class="text-left tight"><code data-bind="text: GameConstants.formatTime(App.game.battleTree.currentRun.combatTime)"></code></td>
            </tr>
            </tbody>
        </table>
        <!-- /ko -->

        <!-- Settings -->
        <div class="card">
            <div class="card-body p-2">
                <table class="table table-striped table-hover table-bordered table-sm m-0">
                    <thead>
                    <tr>
                        <th colspan="2">Settings</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- ko let: { autoSelectRandomModifier: Settings.getSetting('autoSelectRandomModifier') } -->
                    <tr>
                        <td class="text-left vertical-middle" data-bind="text: autoSelectRandomModifier.displayName"></td>
                        <td>
                            <div class="d-flex justify-content-center w-100">
                                <label class="form-check-label toggler-wrapper style-1">
                                    <input class="form-check-input" type="checkbox" id="auto-select-random-modifier"
                                           data-bind="checked: autoSelectRandomModifier.observableValue">
                                    <div class="toggler-slider">
                                        <div class="toggler-knob"></div>
                                    </div>
                                </label>
                            </div>
                        </td>
                    </tr>
                    <!-- /ko -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-body p-2">
                <div class="d-flex flex-wrap justify-content-center" style="gap: 0.5rem;">
                    <!-- ko if: App.game.battleTree.currentRun === null -->
                    <button class="btn btn-success text-light" data-bind="
                        click: () => App.game.battleTree.createNewBattleTreeRun()
                    ">
                        Enter
                    </button>
                    <!-- /ko -->

                    <!-- ko if: App.game.battleTree.currentRun && App.game.battleTree.currentRun?.state === BattleTreeRunState.FINISHED -->
                    <button class="btn btn-success text-light" data-bind="
                        click: () => App.game.battleTree.createNewBattleTreeRun()
                    ">
                        New run
                    </button>
                    <!-- /ko -->

                    <!-- ko if: App.game.battleTree.currentRun && ![BattleTreeRunState.TEAM_SELECTION, BattleTreeRunState.FINISHED].includes(App.game.battleTree.currentRun.state) -->
                    <button class="btn btn-danger text-light" data-bind="
                        click: () => App.game.battleTree.abortRun(),
                        tooltip: {
                            trigger: 'hover',
                            title: `Forfeiting will end the current run, and you will only receive ${BattleTree.FORFEIT_REWARD_MULTIPLIER.toLocaleString('en-US', { style: 'percent' })} of your rewards.`,
                            placement: 'top'
                        }
                    ">
                        Forfeit
                    </button>
                    <!-- /ko -->

                    <button class="btn btn-danger text-light" data-bind="
                        click: () => App.game.battleTree.leave()
                    ">
                        Return to town
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- /ko -->

<div id="battleTreeTeamSelectionModal" aria-labelledby="battleTreeTeamSelectionModal" class="modal fade no-select" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header align-items-center">Select</div>

            <div class="modal-body">
                <p>Every day, a new selection of pokemon will be available for you to create your team from.</p>
                <h3>Available pokemon</h3>
                <div class="d-flex flex-wrap justify-content-center" style="gap: 0.5rem;">
                    <!-- ko foreach: App.game.battleTree.currentRun?.longListSelection().filter(name => App.game.party.alreadyCaughtPokemonByName(name)).sort((a, b) => pokemonMap[a].id - pokemonMap[b].id) ?? [] -->
                    <!-- ko with: pokemonMap[$data] -->
                    <a class="position-relative border" data-bind="
                        enable: true,
                        css: { 'border-info': App.game.battleTree.currentRun?.teamA.map(p => p.name).includes($data.name) },
                        click: () => {
                            if (!App.game.party.alreadyCaughtPokemonByName($data.name)) {
                                return;
                            }
                            if (App.game.battleTree.currentRun?.teamA.map(p => p.name).includes($data.name)) {
                                App.game.battleTree.currentRun?.removePokemonFromPlayerATeam($data.name)
                            } else {
                                App.game.battleTree.currentRun?.addPokemonToPlayerATeam($data.name)
                            }
                        }
                    ">
                        <div class="p-2">
                            <div data-bind="style: { background: PokedexHelper.getBackgroundColors($data.name) }">
                                <img width="96" height="96" style="object-fit: contain;" src="" alt="" data-bind="
                                    attr: {
                                        src: PokemonHelper.getImage($data.id)
                                    }
                                ">
                            </div>
                        </div>
                        <span class="position-absolute px-1 text-truncate" style="color: #f5f5f5; background-color: rgba(0, 0, 0, .5); left: 0; right: 0; bottom: 0;" data-bind="text: PokemonHelper.displayName($data.name)"></span>
                    </a>
                    <!-- /ko -->
                    <!-- /ko -->
                </div>

                <h3>Not available pokemon</h3>
                <div class="d-flex flex-wrap justify-content-center" style="gap: 0.5rem;">
                    <!-- ko foreach: App.game.battleTree.currentRun?.longListSelection().filter(name => !App.game.party.alreadyCaughtPokemonByName(name)).sort((a, b) => pokemonMap[a].id - pokemonMap[b].id) ?? [] -->
                    <!-- ko with: pokemonMap[$data] -->
                    <a class="position-relative border">
                        <div class="p-2">
                            <div>
                                <img width="96" height="96" style="object-fit: contain;" src="" alt="" data-bind="
                                    css: {
                                        'pokemon-not-seen': !PokedexHelper.pokemonSeen($data.id)(),
                                        'pokemon-seen-but-not-caught': !App.game.party.alreadyCaughtPokemonByName($data.name) && PokedexHelper.pokemonSeen($data.id)()
                                    },
                                    attr: {
                                        src: PokemonHelper.getImage($data.id)
                                    }
                                ">
                            </div>
                        </div>
                        <span class="position-absolute px-1 text-truncate" style="color: #f5f5f5; background-color: rgba(0, 0, 0, .5); left: 0; right: 0; bottom: 0;" data-bind="text: !PokedexHelper.pokemonSeen($data.id)() ? '???' : PokemonHelper.displayName($data.name)"></span>
                    </a>
                    <!-- /ko -->
                    <!-- /ko -->
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
