<!-- ko if: App.game.gameState === GameConstants.GameState.battleTree -->
<div id="battleTreeInformation" class="card sortable-disabled border-secondary mb-3 battle-frontier no-select">
    <div class="card-header p-0">
        <span>Battle Tree</span>
    </div>

    <div class="card-body">
        <!-- Team Selection -->
        <div data-bind="if: App.game.battleTree.currentRun?.state === BattleTreeRunState.TEAM_SELECTION">

            <div class="d-flex justify-content-center mb-2" style="gap: 1rem;">
                <!-- ko foreach: App.game.battleTree.currentRun.teamA -->
                <div class="card clickable" style="width: 75px; height: 75px;" data-bind="click: () => App.game.battleTree.currentRun.removePokemonFromPlayerATeam($data.name)">
                    <div class="card-body p-0 d-flex justify-content-center align-items-center">
                        <img class="w-100 h-100" src="" alt="" data-bind="attr: { src: PokemonHelper.getImage(PokemonHelper.getPokemonByName($data.name).id) }">
                    </div>
                </div>
                <!-- /ko -->

                <!-- ko foreach: new Array(3 - App.game.battleTree.currentRun.teamA.length).fill(0) -->
                <div class="card" style="width: 75px; height: 75px;">
                    <a class="card-body p-0 d-flex justify-content-center align-items-center" href="#battleTreeTeamSelectionModal" data-toggle="modal">
                        <code>Empty</code>
                    </a>
                </div>
                <!-- /ko -->
            </div>

            <div class="d-flex justify-content-center" style="gap: 1rem;">
                <button class="btn btn-secondary" data-bind="
                    click: () => App.game.battleTree.currentRun.fillPlayerATeamRandomly(),
                    enable: App.game.battleTree.currentRun.state === BattleTreeRunState.TEAM_SELECTION
                ">
                    Randomize
                </button>
            </div>

        </div>

        <!-- Team Management -->
        <!-- ko if: App.game.battleTree.currentRun && [BattleTreeRunState.BATTLE, BattleTreeRunState.REWARD].includes(App.game.battleTree.currentRun.state) -->
        <div class="d-flex flex-wrap justify-content-center">
            <!-- Your Team -->
            <div class="card flex-grow-1">
                <div class="card-header">Your Team</div>
                <div class="card-body">
                    <!-- ko foreach: App.game.battleTree.currentRun.teamA -->
                    <div class="d-flex">
                        <div>
                            <img width="56" height="56" src="" alt="" data-bind="
                                css: { 'battle-tree-pokemon-fainted': $data.hitPoints === 0 },
                                attr: { src: PokemonHelper.getImage(PokemonHelper.getPokemonByName($data.name).id) }
                            ">
                            <div>Level <knockout data-bind="text: $data.level"></knockout></div>
                        </div>
                        <div class="flex-grow-1">
                            <div>A: <knockout data-bind="text: $data.attack"></knockout></div>
                            <div>D: <knockout data-bind="text: $data.defense"></knockout></div>
                            <div>S: <knockout data-bind="text: $data.attackSpeed"></knockout></div>
                            <div>APS: <knockout data-bind="text: $data.attacksPerSecond.toFixed(2)"></knockout></div>
                            <div class="progress">
                                <div class="progress-bar bg-danger" role="progressbar" aria-valuemin="0" aria-valuemax="100" data-bind="
                                    css: {
                                        'bg-success': $data.hitPoints / $data.maxHitPoints >= 0.5,
                                        'bg-warning': $data.hitPoints / $data.maxHitPoints >= 0.2 && $data.hitPoints / $data.maxHitPoints < 0.5,
                                        'bg-danger': $data.hitPoints / $data.maxHitPoints < 0.2
                                    },
                                    style: { width: ($data.hitPoints / $data.maxHitPoints).toLocaleString('en-US', { style: 'percent' }) }
                                ">
                                    <!-- ko if: $data.hitPoints > 0 -->
                                    <span><knockout data-bind="text: $data.hitPoints.toLocaleString('en-US')"></knockout> / <knockout data-bind="text: $data.maxHitPoints.toLocaleString('en-US')"></knockout></span>
                                    <!-- /ko -->
                                    <!-- ko ifnot: $data.hitPoints > 0 -->
                                    <span class="font-italic">Fainted</span>
                                    <!-- /ko -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /ko -->
                </div>
            </div>

            <!-- Opponent -->
            <div class="card flex-grow-1">
                <div class="card-header">Opponent</div>
                <div class="card-body">
                    <!-- ko foreach: App.game.battleTree.currentRun.teamB -->
                    <div class="d-flex">
                        <div>
                            <img width="56" height="56" src="" alt="" data-bind="attr: { src: PokemonHelper.getImage(PokemonHelper.getPokemonByName($data.name).id) }">
                            <div>Level <knockout data-bind="text: $data.level"></knockout></div>
                        </div>
                        <div class="flex-grow-1">
                            <div>A: <knockout data-bind="text: $data.attack"></knockout></div>
                            <div>D: <knockout data-bind="text: $data.defense"></knockout></div>
                            <div>S: <knockout data-bind="text: $data.attackSpeed"></knockout></div>
                            <div>APS: <knockout data-bind="text: $data.attacksPerSecond.toFixed(2)"></knockout></div>
                            <div class="progress">
                                <div class="progress-bar bg-danger" role="progressbar" aria-valuemin="0" aria-valuemax="100" data-bind="
                                    css: {
                                        'bg-success': $data.hitPoints / $data.maxHitPoints >= 0.5,
                                        'bg-warning': $data.hitPoints / $data.maxHitPoints >= 0.2 && $data.hitPoints / $data.maxHitPoints < 0.5,
                                        'bg-danger': $data.hitPoints / $data.maxHitPoints < 0.2
                                    },
                                    style: { width: ($data.hitPoints / $data.maxHitPoints).toLocaleString('en-US', { style: 'percent' }) }
                                ">
                                    <!-- ko if: $data.hitPoints > 0 -->
                                    <span><knockout data-bind="text: $data.hitPoints.toLocaleString('en-US')"></knockout> / <knockout data-bind="text: $data.maxHitPoints.toLocaleString('en-US')"></knockout></span>
                                    <!-- /ko -->
                                    <!-- ko ifnot: $data.hitPoints > 0 -->
                                    <span class="font-italic">Fainted</span>
                                    <!-- /ko -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /ko -->
                </div>
            </div>
        </div>
        <!-- /ko -->

        <!-- ko if: App.game.battleTree.currentRun?.state === BattleTreeRunState.FINISHED -->
        <div>
            <div>Stage: <knockout data-bind="text: App.game.battleTree.currentRun.stage"></knockout></div>

            <div>Team</div>
            <div class="d-flex justify-content-center mb-2" style="gap: 1rem;">
                <!-- ko foreach: App.game.battleTree.currentRun.teamA -->
                <div class="card" style="width: 75px; height: 75px;">
                    <div class="card-body p-0 d-flex justify-content-center align-items-center">
                        <img class="w-100 h-100" src="" alt="" data-bind="attr: { src: PokemonHelper.getImage(PokemonHelper.getPokemonByName($data.name).id) }">
                    </div>
                </div>
                <!-- /ko -->
            </div>

            <table class="table table-striped table-hover table-bordered table-sm m-0">
                <tbody>
                <tr>
                    <td class="text-left">Runtime</td>
                    <td class="text-left tight"><code data-bind="text: GameConstants.formatTime(App.game.battleTree.currentRun.runTime)"></code></td>
                </tr>
                <tr>
                    <td class="text-left">Combat time</td>
                    <td class="text-left tight"><code data-bind="text: GameConstants.formatTime(App.game.battleTree.currentRun.combatTime)"></code></td>
                </tr>
                </tbody>
            </table>
        </div>
        <!-- /ko -->

        <div>
            <!-- ko let: { autoSelectRandomModifier: Settings.getSetting('autoSelectRandomModifier') } -->
            <label for="auto-select-random-modifier" data-bind="text: autoSelectRandomModifier.displayName"></label>
            <label class="form-check-label toggler-wrapper style-1 float-right">
                <input class="form-check-input" type="checkbox" id="auto-select-random-modifier"
                       data-bind="checked: autoSelectRandomModifier.observableValue">
                <div class="toggler-slider">
                    <div class="toggler-knob"></div>
                </div>
            </label>
            <!-- /ko -->
        </div>

        <!-- ko if: App.game.battleTree.currentRun === null -->
        <button class="btn btn-block btn-success text-light" data-bind="
            click: () => App.game.battleTree.createNewBattleTreeRun()
        ">
            Enter
        </button>
        <!-- /ko -->

        <!-- ko if: App.game.battleTree.currentRun?.state === BattleTreeRunState.TEAM_SELECTION -->
        <button class="btn btn-block btn-success text-light" data-bind="
            click: () => App.game.battleTree.currentRun.startRun(),
            enable: App.game.battleTree.currentRun.teamA.length > 0
        ">
            Start
        </button>
        <!-- /ko -->

        <!-- ko if: App.game.battleTree.currentRun && App.game.battleTree.currentRun?.state === BattleTreeRunState.FINISHED -->
        <button class="btn btn-block btn-success text-light" data-bind="
            click: () => App.game.battleTree.createNewBattleTreeRun()
        ">
            New run
        </button>
        <!-- /ko -->

        <!-- ko if: App.game.battleTree.currentRun && App.game.battleTree.currentRun?.state !== BattleTreeRunState.FINISHED -->
        <button class="btn btn-block btn-danger text-light" data-bind="
            click: () => App.game.battleTree.abortRun()
        ">
            Abort
        </button>
        <!-- /ko -->

        <button class="btn btn-block btn-danger text-light" data-bind="
            click: () => App.game.battleTree.leave()
        ">
            Leave
        </button>
    </div>
</div>
<!-- /ko -->

<div id="battleTreeTeamSelectionModal" aria-labelledby="battleTreeTeamSelectionModal" class="modal fade no-select" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header align-items-center">Select</div>

            <div class="modal-body">
                <p>Every day, a new selection of pokemon will be available for you to create your team from.</p>
                <h3>Available pokemon</h3>
                <div class="d-flex flex-wrap justify-content-center" style="gap: 0.5rem;">
                    <!-- ko foreach: App.game.battleTree.currentRun?.longListSelection().filter(name => App.game.party.alreadyCaughtPokemonByName(name)).sort((a, b) => pokemonMap[a].id - pokemonMap[b].id) ?? [] -->
                    <!-- ko with: pokemonMap[$data] -->
                    <a class="position-relative border" data-bind="
                        enable: true,
                        css: { 'border-info': App.game.battleTree.currentRun?.teamA.map(p => p.name).includes($data.name) },
                        click: () => {
                            if (!App.game.party.alreadyCaughtPokemonByName($data.name)) {
                                return;
                            }
                            if (App.game.battleTree.currentRun?.teamA.map(p => p.name).includes($data.name)) {
                                App.game.battleTree.currentRun?.removePokemonFromPlayerATeam($data.name)
                            } else {
                                App.game.battleTree.currentRun?.addPokemonToPlayerATeam($data.name)
                            }
                        }
                    ">
                        <div class="p-2">
                            <div data-bind="style: { background: PokedexHelper.getBackgroundColors($data.name) }">
                                <img width="96" height="96" style="object-fit: contain;" src="" alt="" data-bind="
                                    attr: {
                                        src: PokemonHelper.getImage($data.id)
                                    }
                                ">
                            </div>
                        </div>
                        <span class="position-absolute px-1 text-truncate" style="color: #f5f5f5; background-color: rgba(0, 0, 0, .5); left: 0; right: 0; bottom: 0;" data-bind="text: PokemonHelper.displayName($data.name)"></span>
                    </a>
                    <!-- /ko -->
                    <!-- /ko -->
                </div>

                <h3>Not available pokemon</h3>
                <div class="d-flex flex-wrap justify-content-center" style="gap: 0.5rem;">
                    <!-- ko foreach: App.game.battleTree.currentRun?.longListSelection().filter(name => !App.game.party.alreadyCaughtPokemonByName(name)).sort((a, b) => pokemonMap[a].id - pokemonMap[b].id) ?? [] -->
                    <!-- ko with: pokemonMap[$data] -->
                    <a class="position-relative border">
                        <div class="p-2">
                            <div>
                                <img width="96" height="96" style="object-fit: contain;" src="" alt="" data-bind="
                                    css: {
                                        'pokemon-not-seen': !PokedexHelper.pokemonSeen($data.id)(),
                                        'pokemon-seen-but-not-caught': !App.game.party.alreadyCaughtPokemonByName($data.name) && PokedexHelper.pokemonSeen($data.id)()
                                    },
                                    attr: {
                                        src: PokemonHelper.getImage($data.id)
                                    }
                                ">
                            </div>
                        </div>
                        <span class="position-absolute px-1 text-truncate" style="color: #f5f5f5; background-color: rgba(0, 0, 0, .5); left: 0; right: 0; bottom: 0;" data-bind="text: !PokedexHelper.pokemonSeen($data.id)() ? '???' : PokemonHelper.displayName($data.name)"></span>
                    </a>
                    <!-- /ko -->
                    <!-- /ko -->
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
